<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Matematik Oyunu</title>
<style>
  :root{--bg:#222;--fg:#eee;--muted:#888;--accent:#2ecc71}
  body{font-family:Arial,system-ui;margin:0;background:var(--bg);color:var(--fg);-webkit-font-smoothing:antialiased}
  .wrap{max-width:560px;margin:18px auto;padding:16px}
  h1{margin:0 0 10px;font-size:22px}
  .topbar{display:flex;justify-content:space-between;align-items:center}
  input,button{font-size:18px;padding:10px;border-radius:8px;border:0;outline:none}
  input{min-width:140px}
  button{background:#333;color:var(--fg)}
  .controls{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  #bgControls{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #bgControls.hidden{display:none}
  #gameArea{margin-top:14px}
  #question{font-size:20px;font-weight:700;margin:12px 0}
  #result{min-height:28px;font-weight:700;transition:opacity .35s}
  #leaderboard{margin-top:12px;text-align:left;display:inline-block;min-width:180px}
  .version{position:fixed;left:8px;bottom:6px;font-size:12px;color:var(--muted)}
  .big{padding:12px 16px;font-size:18px;border-radius:10px}
  @media (max-width:420px){ input,button{font-size:16px;padding:10px} h1{font-size:20px} }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1>Matematik Oyunu</h1>
    <div id="miniInfo" style="font-size:13px"></div>
  </div>

  <div id="menu">
    <p>Kullanıcı adını gir:</p>
    <div class="controls">
      <input id="playerName" placeholder="Adın?" autocomplete="off" />
      <button id="guestBtn" class="big">Misafir Gir</button>
      <button id="startBtn" class="big">Başla</button>
      <button id="bgBtn" class="big">Arka Plan</button>
    </div>

    <div id="bgControls" class="hidden">
      Renk: <input id="bgColor" type="color" value="#222222" />
      Fotoğraf: <input id="bgImage" type="file" accept="image/*" />
    </div>
  </div>

  <div id="gameArea" class="hidden" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <div>Oyuncu: <strong id="playerDisplay"></strong></div>
      <div>Puan: <strong id="scoreDisplay">0</strong></div>
      <div><button id="menuBtn" class="big">Ana Menü</button></div>
    </div>

    <hr />

    <div id="questionZone">
      <p id="question">Soru yükleniyor...</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="answer" placeholder="Cevabın?" autocomplete="off" inputmode="decimal" />
        <button id="submitBtn" class="big">Gönder</button>
      </div>
      <p id="result"></p>
    </div>

    <h3>Puan Tablosu</h3>
    <div id="leaderboard">Henüz kimse yok</div>
  </div>
</div>

<div class="version">v1.0.3</div>

<script>
/* 1.0.3 -> updated offline friendly: buttons fixed + Misafir login */
/* Local storage key */
const STORAGE_KEY = 'mathgame_leaderboard_v1';

/* UI refs */
const playerNameInput = document.getElementById('playerName');
const guestBtn = document.getElementById('guestBtn');
const startBtn = document.getElementById('startBtn');
const bgBtn = document.getElementById('bgBtn');
const bgControls = document.getElementById('bgControls');
const bgColor = document.getElementById('bgColor');
const bgImage = document.getElementById('bgImage');
const menu = document.getElementById('menu');
const gameArea = document.getElementById('gameArea');
const playerDisplay = document.getElementById('playerDisplay');
const scoreDisplay = document.getElementById('scoreDisplay');
const questionEl = document.getElementById('question');
const answerInput = document.getElementById('answer');
const submitBtn = document.getElementById('submitBtn');
const resultEl = document.getElementById('result');
const leaderboardEl = document.getElementById('leaderboard');
const menuBtn = document.getElementById('menuBtn');
const miniInfo = document.getElementById('miniInfo');

let player = null;
let score = 0;
let question = '';
let correct = 0;
let leaderboard = loadLeaderboard();

/* messages */
const correctMessages = ["Aferin!", "Harika!", "Süper!", "Bravo!", "Tam isabet!"];
const wrongMessages = ["Hmm yanlış...", "Bir daha dene!", "Yanlış oldu!", "Doğrusunu biraz bekle..."];

/* events */
guestBtn.addEventListener('click', guestLogin);
startBtn.addEventListener('click', startGame);
bgBtn.addEventListener('click', ()=> bgControls.classList.toggle('hidden'));
bgColor.addEventListener('change', ()=> setBackgroundColor(bgColor.value));
bgImage.addEventListener('change', handleBgImage);
submitBtn.addEventListener('click', checkAnswer);
menuBtn.addEventListener('click', goMenu);

/* keyboard */
answerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitBtn.click(); });
playerNameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') startBtn.click(); });

/* helper: load/save */
function loadLeaderboard(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
  }catch(e){ return {}; }
}
function saveLeaderboard(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(leaderboard)); }catch(e){}
}
function escapeHtml(text=''){ return String(text).replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

/* guest login */
function guestLogin(){
  const base = 'Misafir';
  let id = Math.floor(Math.random()*9000)+1000;
  let name = `${base}-${id}`;
  // ensure uniqueness in leaderboard keys
  while(leaderboard[name] !== undefined){ id = Math.floor(Math.random()*9000)+1000; name = `${base}-${id}`; }
  playerNameInput.value = name;
  startGame(); // automatically start
}

/* start game */
function startGame(){
  const name = playerNameInput.value.trim();
  if(!name){ resultEl.innerText='Adını gir ya.'; resultEl.style.color='orange'; return; }
  player = name;
  if(leaderboard[player] === undefined) leaderboard[player] = 0;
  score = leaderboard[player] || 0;
  playerDisplay.innerText = escapeHtml(player);
  scoreDisplay.innerText = score;
  menu.style.display = 'none';
  gameArea.classList.remove('hidden');
  gameArea.setAttribute('aria-hidden','false');
  answerInput.value = '';
  answerInput.focus();
  askQuestion();
  renderLeaderboard();
  updateMini();
}

/* return to menu */
function goMenu(){
  menu.style.display = '';
  gameArea.classList.add('hidden');
  gameArea.setAttribute('aria-hidden','true');
  resultEl.innerText = '';
  playerNameInput.value = player || '';
  updateMini();
}

/* question generator */
function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function askQuestion(){
  const a = randomInt(1,10);
  const b = randomInt(1,10);
  const ops = ['+','-','*','/'];
  const op = ops[randomInt(0,3)];
  if(op === '/'){
    const prod = a * b;
    question = `${prod} / ${a}`;
    correct = Math.round((prod / a) * 100) / 100;
  } else {
    question = `${a} ${op} ${b}`;
    correct = Math.round(eval(question) * 100) / 100;
  }
  questionEl.innerText = question + ' = ?';
  resultEl.innerText = '';
  resultEl.style.opacity = 1;
  enableInput();
}

/* number comparison tolerant */
function nearlyEqual(a,b,eps=0.01){ return Math.abs(a-b) < eps; }
function disableInput(){ answerInput.disabled = true; submitBtn.disabled = true; }
function enableInput(){ answerInput.disabled = false; submitBtn.disabled = false; answerInput.focus(); }

/* answer checking */
function checkAnswer(){
  const raw = answerInput.value.trim();
  if(raw === ''){ resultEl.innerText='Cevap gir!'; resultEl.style.color='orange'; return; }
  const user = parseFloat(raw.replace(',','.'));
  if(Number.isNaN(user)){ resultEl.innerText='Sayı gir!'; resultEl.style.color='orange'; return; }

  disableInput();

  if(nearlyEqual(user, correct)){
    // correct
    const msg = correctMessages[randomInt(0,correctMessages.length-1)];
    resultEl.innerText = msg; resultEl.style.color = '#2ecc71';
    score += 10;
    leaderboard[player] = score;
    saveLeaderboard();
    renderLeaderboard();
    scoreDisplay.innerText = score;
    // fade & next
    setTimeout(()=>{ resultEl.style.opacity = 0.6; }, 1000);
    setTimeout(()=>{ resultEl.innerText = ''; resultEl.style.opacity = 1; askQuestion(); }, 1600);
  } else {
    // wrong
    const msg = wrongMessages[randomInt(0,wrongMessages.length-1)];
    resultEl.innerText = msg; resultEl.style.color = '#ff6b6b';
    score -= 5;
    if(score < 0) score = 0;
    leaderboard[player] = score;
    saveLeaderboard();
    renderLeaderboard();
    scoreDisplay.innerText = score;
    // show correct after short delay
    setTimeout(()=>{ resultEl.innerText = `Doğrusu: ${correct}`; resultEl.style.color = '#ffd700'; }, 1200);
    // clear & next
    setTimeout(()=>{ resultEl.innerText = ''; askQuestion(); }, 2200);
  }
  answerInput.value = '';
}

/* leaderboard render */
function renderLeaderboard(){
  const entries = Object.entries(leaderboard).sort((a,b)=>b[1]-a[1]);
  if(entries.length === 0) { leaderboardEl.innerHTML = '<i>Henüz kimse yok</i>'; return; }
  leaderboardEl.innerHTML = entries.map(e=>`${escapeHtml(e[0])}: ${e[1]} puan`).join('<br>');
}

/* background handling */
function setBackgroundColor(hex){
  document.body.style.background = hex;
  adjustTextColor(hex);
}
function handleBgImage(){
  const file = bgImage.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=> {
    document.body.style.background = `url(${e.target.result}) center/cover no-repeat`;
    document.body.style.backgroundBlendMode = 'overlay';
    adjustTextColor('#000'); // assume dark image
  };
  reader.readAsDataURL(file);
}
/* adjust text colour based on a hex color (simple luminance) */
function adjustTextColor(hex){
  if(!/^#([0-9A-F]{3}){1,2}$/i.test(hex)){ document.body.style.color = '#eee'; return; }
  let c = hex.substring(1);
  if(c.length === 3) c = c.split('').map(ch=>ch+ch).join('');
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  const lum = 0.2126*r + 0.7152*g + 0.0722*b;
  document.body.style.color = lum > 150 ? '#111' : '#eee';
}

/* mini info */
function updateMini(){ miniInfo.innerText = player ? `${player} • ${score}p` : ''; }

/* init */
renderLeaderboard();
updateMini();
setBackgroundColor(bgColor.value);

/* quick note: expose some things for debugging in console if needed */
window._MG = { leaderboard, askQuestion, renderLeaderboard };
</script>
</body>
</html>
